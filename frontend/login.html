<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TaskPulse - Internal Business Automation for Daily Work Reporting">
  <title>TaskPulse - Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <!-- Floating Orbs Background -->
  <div class="floating-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <div class="login-page">
    <div class="login-container">
      <div class="login-card animate-slideUp">
        <div class="login-header">
          <div class="login-logo">
            <span class="login-logo-icon">üìä</span>
          </div>
          <h1 class="login-title">TaskPulse</h1>
          <p class="login-subtitle">Internal Work Reporting System</p>
        </div>

        <div class="login-body">
          <div class="login-tabs">
            <button class="login-tab active" data-tab="login">Sign In</button>
            <button class="login-tab" data-tab="register">Register</button>
          </div>

          <!-- Login Form -->
          <form id="loginForm" class="login-form active">
            <div class="form-group">
              <label class="form-label required" for="loginEmail">Email Address</label>
              <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required
                autocomplete="email">
            </div>

            <div class="form-group">
              <label class="form-label required" for="loginPassword">Password</label>
              <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required
                autocomplete="current-password">
            </div>

            <button type="submit" class="btn btn-primary btn-lg btn-block">
              Sign In
            </button>

            <div class="text-center mt-md">
              <a href="forgot-password.html" style="color: var(--accent-purple); font-size: 0.875rem;">
                Forgot your password?
              </a>
            </div>

            <!-- Divider -->
            <div style="display: flex; align-items: center; margin: var(--spacing-lg) 0; gap: var(--spacing-md);">
              <div
                style="flex: 1; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);">
              </div>
              <span
                style="color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">or</span>
              <div
                style="flex: 1; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);">
              </div>
            </div>

            <!-- Google Sign In -->
            <a href="http://localhost:5001/api/auth/google" class="btn btn-google btn-lg btn-block"
              style="background: white; color: #333; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); text-decoration: none; font-weight: 500;">
              <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                <path fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                <path fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                <path fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
              </svg>
              Continue with Google
            </a>
          </form>

          <!-- Register Form -->
          <form id="registerForm" class="login-form">
            <!-- Step 1: Email Verification -->
            <div id="emailStep">
              <!-- Google Sign Up (Quick Option) -->
              <a href="http://localhost:5001/api/auth/google" class="btn btn-google btn-lg btn-block"
                style="background: white; color: #333; display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); text-decoration: none; font-weight: 500; margin-bottom: var(--spacing-md);">
                <svg width="20" height="20" viewBox="0 0 24 24">
                  <path fill="#4285F4"
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                  <path fill="#34A853"
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                  <path fill="#FBBC05"
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                  <path fill="#EA4335"
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Sign up with Google
              </a>

              <!-- Divider -->
              <div style="display: flex; align-items: center; margin: var(--spacing-md) 0; gap: var(--spacing-md);">
                <div
                  style="flex: 1; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);">
                </div>
                <span
                  style="color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">or</span>
                <div
                  style="flex: 1; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);">
                </div>
              </div>

              <div class="info-box"
                style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: var(--radius-lg); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <p
                  style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                  <span style="font-size: 1rem;">üìß</span>
                  <span>Or verify your email to create an account.</span>
                </p>
              </div>

              <div class="form-group">
                <label class="form-label required" for="registerEmail">Email Address</label>
                <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required
                  autocomplete="email">
              </div>

              <button type="button" id="sendOtpBtn" class="btn btn-primary btn-lg btn-block">
                üìß Verify Email
              </button>
            </div>

            <!-- Step 2: OTP Verification -->
            <div id="otpStep" style="display: none;">
              <div class="info-box"
                style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(74, 222, 128, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: var(--radius-lg); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <p
                  style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                  <span style="font-size: 1rem;">‚úâÔ∏è</span>
                  <span>We've sent a 6-digit code to <strong id="emailDisplay"></strong></span>
                </p>
              </div>

              <div class="form-group">
                <label class="form-label required" for="otpInput">Enter OTP Code</label>
                <input type="text" id="otpInput" class="form-control" placeholder="Enter 6-digit code" maxlength="6"
                  pattern="[0-9]{6}"
                  style="text-align: center; font-size: 1.5rem; letter-spacing: 8px; font-weight: 600;">
                <div class="form-hint">Code expires in 5 minutes</div>
              </div>

              <div class="flex gap-md">
                <button type="button" id="resendOtpBtn" class="btn btn-secondary flex-1">
                  Resend OTP
                </button>
                <button type="button" id="verifyOtpBtn" class="btn btn-primary flex-1">
                  ‚úì Verify
                </button>
              </div>
            </div>

            <!-- Step 3: Complete Registration -->
            <div id="registrationStep" style="display: none;">
              <div class="info-box"
                style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(74, 222, 128, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: var(--radius-lg); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <p
                  style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                  <span style="font-size: 1rem;">‚úÖ</span>
                  <span>Email verified! Complete your registration below.</span>
                </p>
              </div>

              <div class="form-group">
                <label class="form-label required" for="registerName">Full Name</label>
                <input type="text" id="registerName" class="form-control" placeholder="Enter your full name"
                  autocomplete="name">
              </div>

              <div class="form-group">
                <label class="form-label required" for="registerPassword">Password</label>
                <input type="password" id="registerPassword" class="form-control"
                  placeholder="Create a password (min. 6 characters)" minlength="6" autocomplete="new-password">
              </div>

              <div class="form-group">
                <label class="form-label" for="registerDepartment">Department</label>
                <input type="text" id="registerDepartment" class="form-control"
                  placeholder="e.g., Engineering, Marketing" autocomplete="organization">
              </div>

              <div class="form-group">
                <label class="form-label" for="registerRole">Role</label>
                <select id="registerRole" class="form-control form-select">
                  <option value="employee">Employee</option>
                  <option value="manager">Manager</option>
                </select>
              </div>

              <button type="submit" class="btn btn-primary btn-lg btn-block">
                üöÄ Create Account
              </button>
            </div>
          </form>
        </div>

        <div class="login-footer">
          <p>TaskPulse v1.0 ‚Ä¢ Internal Use Only</p>
        </div>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script>
    // Redirect if already logged in
    auth.redirectIfAuthenticated();

    // Tab switching
    const tabs = document.querySelectorAll('.login-tab');
    const forms = document.querySelectorAll('.login-form');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        forms.forEach(form => {
          form.classList.remove('active');
          if (form.id === `${tabName}Form`) {
            form.classList.add('active');
          }
        });
      });
    });

    // Login form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showToast('Please fill in all fields', 'error');
        return;
      }

      try {
        showLoading();
        const response = await auth.login(email, password);

        if (response.success) {
          showToast('Login successful! Redirecting...', 'success');
          setTimeout(() => {
            const user = response.data.user;
            if (['manager', 'admin'].includes(user.role)) {
              window.location.href = 'dashboard.html';
            } else {
              window.location.href = 'submit-report.html';
            }
          }, 1000);
        }
      } catch (error) {
        showToast(error.message || 'Login failed', 'error');
      } finally {
        hideLoading();
      }
    });

    // Register form - OTP Flow
    let verifiedEmail = null;

    // Step 1: Send OTP
    document.getElementById('sendOtpBtn').addEventListener('click', async () => {
      const email = document.getElementById('registerEmail').value.trim();

      if (!email) {
        showToast('Please enter your email address', 'error');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast('Please enter a valid email address', 'error');
        return;
      }

      try {
        const btn = document.getElementById('sendOtpBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></span> Sending...';

        const response = await api.sendOTP(email);

        if (response.success) {
          showToast('OTP sent to your email!', 'success');

          // Move to OTP step
          document.getElementById('emailStep').style.display = 'none';
          document.getElementById('otpStep').style.display = 'block';
          document.getElementById('emailDisplay').textContent = email;
          document.getElementById('otpInput').focus();

          // Show OTP in development mode (for testing)
          if (response.data && response.data.otp) {
            console.log('üìß Development OTP:', response.data.otp);
            showToast(`Dev Mode - OTP: ${response.data.otp}`, 'info');
          }
        }
      } catch (error) {
        showToast(error.message || 'Failed to send OTP', 'error');
      } finally {
        const btn = document.getElementById('sendOtpBtn');
        btn.disabled = false;
        btn.innerHTML = 'üìß Verify Email';
      }
    });

    // Resend OTP
    document.getElementById('resendOtpBtn').addEventListener('click', async () => {
      const email = document.getElementById('registerEmail').value.trim();

      try {
        const btn = document.getElementById('resendOtpBtn');
        btn.disabled = true;
        btn.textContent = 'Sending...';

        const response = await api.sendOTP(email);

        if (response.success) {
          showToast('New OTP sent!', 'success');

          if (response.data && response.data.otp) {
            console.log('üìß Development OTP:', response.data.otp);
            showToast(`Dev Mode - OTP: ${response.data.otp}`, 'info');
          }
        }
      } catch (error) {
        showToast(error.message || 'Failed to resend OTP', 'error');
      } finally {
        const btn = document.getElementById('resendOtpBtn');
        btn.disabled = false;
        btn.textContent = 'Resend OTP';
      }
    });

    // Step 2: Verify OTP
    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
      const email = document.getElementById('registerEmail').value.trim();
      const otp = document.getElementById('otpInput').value.trim();

      if (!otp || otp.length !== 6) {
        showToast('Please enter a valid 6-digit OTP', 'error');
        return;
      }

      try {
        const btn = document.getElementById('verifyOtpBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>';

        const response = await api.verifyOTP(email, otp);

        if (response.success) {
          showToast('Email verified successfully!', 'success');
          verifiedEmail = email;

          // Move to registration step
          document.getElementById('otpStep').style.display = 'none';
          document.getElementById('registrationStep').style.display = 'block';
          document.getElementById('registerName').focus();
        }
      } catch (error) {
        showToast(error.message || 'Invalid or expired OTP', 'error');
      } finally {
        const btn = document.getElementById('verifyOtpBtn');
        btn.disabled = false;
        btn.innerHTML = '‚úì Verify';
      }
    });

    // Step 3: Complete Registration
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Only process if we're on the registration step
      if (!verifiedEmail) {
        showToast('Please verify your email first', 'error');
        return;
      }

      const name = document.getElementById('registerName').value.trim();
      const password = document.getElementById('registerPassword').value;
      const department = document.getElementById('registerDepartment').value.trim();
      const role = document.getElementById('registerRole').value;

      if (!name) {
        showToast('Please enter your full name', 'error');
        return;
      }

      if (!password || password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        showLoading();
        const response = await auth.register({
          name,
          email: verifiedEmail,
          password,
          department: department || 'General',
          role
        });

        if (response.success) {
          showToast('Account created successfully! Redirecting...', 'success');
          setTimeout(() => {
            const user = response.data.user;
            if (['manager', 'admin'].includes(user.role)) {
              window.location.href = 'dashboard.html';
            } else {
              window.location.href = 'submit-report.html';
            }
          }, 1000);
        }
      } catch (error) {
        showToast(error.message || 'Registration failed', 'error');
      } finally {
        hideLoading();
      }
    });

  </script>
</body>

</html>